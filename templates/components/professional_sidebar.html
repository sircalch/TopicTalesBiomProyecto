{% load static %}

<!-- TopicTales Biomédica - Professional Sidebar (Datta/Black Style) -->
<aside class="professional-sidebar" id="professional-sidebar">
    
    <!-- Brand Section -->
    <div class="sidebar-brand">
        <div class="brand-wrapper">
            <div class="brand-icon">
                <i class="bi bi-heart-pulse-fill"></i>
            </div>
            <div class="brand-text">
                <span class="brand-name">TopicTales</span>
                <small class="brand-subtitle">Biomédica</small>
            </div>
        </div>
    </div>

    <!-- User Profile Section -->
    <div class="user-section">
        <div class="user-card">
            <div class="user-avatar">
                {% if user.profile.avatar %}
                    <img src="{{ user.profile.avatar.url }}" alt="{{ user.get_full_name }}">
                {% else %}
                    <div class="avatar-circle">
                        {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                    </div>
                {% endif %}
                <div class="status-badge"></div>
            </div>
            <div class="user-info">
                <div class="user-name">{{ user.get_full_name|default:user.username }}</div>
                <div class="user-role">{% if user.profile %}{{ user.profile.role|default:"Médico" }}{% else %}Médico{% endif %}</div>
            </div>
        </div>
    </div>

    <!-- Navigation Menu -->
    <nav class="sidebar-nav">
        <div class="nav-content">
            
            <!-- Dashboard -->
            <div class="nav-item">
                <a href="{% url 'dashboard:index' %}" class="nav-link {% if request.resolver_match.namespace == 'dashboard' %}active{% endif %}">
                    <i class="nav-icon bi bi-speedometer2"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
            </div>

            <!-- Dynamic Module Categories -->
            {% for category, modules in sidebar_modules.items %}
                {% if modules %}
                    <div class="nav-group">
                        <div class="group-title">
                            {% if category == 'core' %}
                                Gestión Principal
                            {% elif category == 'medical' %}
                                Especialidades Médicas
                            {% elif category == 'admin' %}
                                Administración
                            {% elif category == 'reports' %}
                                Reportes y Analytics
                            {% elif category == 'communication' %}
                                Comunicación
                            {% elif category == 'integration' %}
                                Integraciones
                            {% else %}
                                {{ category|title }}
                            {% endif %}
                        </div>

                        {% for module_data in modules %}
                            {% with module=module_data.module submodules=module_data.submodules %}
                                {% if submodules %}
                                    <!-- Module with Submenu -->
                                    <div class="nav-item dropdown-nav" data-module="{{ module.name|slugify }}">
                                        <button class="nav-link dropdown-btn" onclick="toggleProDropdown('{{ module.name|slugify }}')">
                                            <i class="nav-icon bi {{ module.icon|default:'bi-folder2' }}"></i>
                                            <span class="nav-text">{{ module.display_name }}</span>
                                            {% if user_subscription.plan == 'BASIC' and module.min_plan_required != 'BASIC' %}
                                                <span class="pro-tag">PRO</span>
                                            {% endif %}
                                            <i class="dropdown-icon bi bi-chevron-right"></i>
                                        </button>
                                        <div class="submenu" id="submenu-{{ module.name|slugify }}">
                                            {% for submodule in submodules %}
                                                <a href="{% if submodule.url_name %}{% url submodule.url_name %}{% else %}#{% endif %}" class="submenu-link">
                                                    <i class="submenu-icon bi {{ submodule.icon|default:'bi-circle' }}"></i>
                                                    <span>{{ submodule.display_name }}</span>
                                                </a>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% else %}
                                    <!-- Simple Module -->
                                    <div class="nav-item">
                                        <a href="{% if module.url_name %}{% url module.url_name %}{% else %}#{% endif %}" class="nav-link">
                                            <i class="nav-icon bi {{ module.icon|default:'bi-folder2' }}"></i>
                                            <span class="nav-text">{{ module.display_name }}</span>
                                            {% if user_subscription.plan == 'BASIC' and module.min_plan_required != 'BASIC' %}
                                                <span class="pro-tag">PRO</span>
                                            {% endif %}
                                        </a>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </div>
                {% endif %}
            {% endfor %}

            <!-- Fallback Static Menu -->
            {% if not sidebar_modules %}
                <div class="nav-group">
                    <div class="group-title">Gestión Médica</div>

                    <!-- Patients -->
                    <div class="nav-item dropdown-nav" data-module="patients">
                        <button class="nav-link dropdown-btn" onclick="toggleProDropdown('patients')">
                            <i class="nav-icon bi bi-people-fill"></i>
                            <span class="nav-text">Pacientes</span>
                            <span class="count-badge">{{ subscription_features.current_patients|default:0 }}</span>
                            <i class="dropdown-icon bi bi-chevron-right"></i>
                        </button>
                        <div class="submenu" id="submenu-patients">
                            <a href="{% url 'patients:list' %}" class="submenu-link">
                                <i class="submenu-icon bi bi-list-ul"></i>
                                <span>Lista de Pacientes</span>
                            </a>
                            <a href="{% url 'patients:create' %}" class="submenu-link">
                                <i class="submenu-icon bi bi-person-plus"></i>
                                <span>Nuevo Paciente</span>
                            </a>
                            <a href="{% url 'patients:search' %}" class="submenu-link">
                                <i class="submenu-icon bi bi-search"></i>
                                <span>Búsqueda Avanzada</span>
                            </a>
                        </div>
                    </div>

                    <!-- Appointments -->
                    <div class="nav-item dropdown-nav" data-module="appointments">
                        <button class="nav-link dropdown-btn" onclick="toggleProDropdown('appointments')">
                            <i class="nav-icon bi bi-calendar-event-fill"></i>
                            <span class="nav-text">Agenda</span>
                            <span class="count-badge urgent">8</span>
                            <i class="dropdown-icon bi bi-chevron-right"></i>
                        </button>
                        <div class="submenu" id="submenu-appointments">
                            <a href="{% url 'appointments:calendar' %}" class="submenu-link">
                                <i class="submenu-icon bi bi-calendar3"></i>
                                <span>Calendario</span>
                            </a>
                            <a href="{% url 'appointments:list' %}" class="submenu-link">
                                <i class="submenu-icon bi bi-list-check"></i>
                                <span>Lista de Citas</span>
                            </a>
                            <a href="{% url 'appointments:create' %}" class="submenu-link">
                                <i class="submenu-icon bi bi-plus-circle"></i>
                                <span>Nueva Cita</span>
                            </a>
                        </div>
                    </div>

                    <!-- Medical Records -->
                    <div class="nav-item">
                        <a href="{% url 'medical_records:index' %}" class="nav-link">
                            <i class="nav-icon bi bi-file-medical-fill"></i>
                            <span class="nav-text">Expedientes</span>
                        </a>
                    </div>

                    <!-- Reports -->
                    <div class="nav-item">
                        <a href="{% url 'reports:index' %}" class="nav-link">
                            <i class="nav-icon bi bi-graph-up"></i>
                            <span class="nav-text">Reportes</span>
                        </a>
                    </div>
                </div>

                <!-- Admin Section -->
                {% if user.is_superuser %}
                    <div class="nav-group">
                        <div class="group-title">Administración</div>
                        <div class="nav-item">
                            <a href="{% url 'admin:index' %}" class="nav-link">
                                <i class="nav-icon bi bi-gear-fill"></i>
                                <span class="nav-text">Panel Admin</span>
                            </a>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
            
        </div>
    </nav>

    <!-- Subscription Card -->
    <div class="subscription-section">
        <div class="subscription-card">
            <div class="subscription-header">
                <i class="plan-icon bi bi-award-fill"></i>
                <div class="plan-info">
                    <div class="plan-name">{{ user_subscription.plan|default:"Plan Básico" }}</div>
                    <div class="plan-usage">{{ subscription_features.current_patients|default:0 }}{% if subscription_features.max_patients != -1 %}/{{ subscription_features.max_patients }}{% endif %} pacientes</div>
                </div>
            </div>
            <div class="usage-progress">
                {% with usage_percent=subscription_features.current_patients|default:0|floatformat:0 %}
                    {% if subscription_features.max_patients > 0 %}
                        {% widthratio subscription_features.current_patients subscription_features.max_patients 100 as percentage %}
                        <div class="progress-fill" style="width: {{ percentage }}%"></div>
                    {% else %}
                        <div class="progress-fill" style="width: 30%"></div>
                    {% endif %}
                {% endwith %}
            </div>
            {% if user_subscription.plan == 'BASIC' %}
                <a href="{% url 'accounts:subscription' %}" class="upgrade-btn">
                    <i class="bi bi-arrow-up-circle"></i>
                    Actualizar Plan
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Footer -->
    <div class="sidebar-footer">
        <a href="{% url 'accounts:logout' %}" class="logout-link">
            <i class="bi bi-box-arrow-right"></i>
            <span>Cerrar Sesión</span>
        </a>
    </div>

</aside>

<!-- Mobile Overlay -->
<div class="sidebar-overlay d-lg-none" id="sidebar-overlay"></div>

<!-- Professional Sidebar Styles -->
<style>
/* Professional Dashboard Variables */
:root {
    --pro-sidebar-width: 280px;
    --pro-primary: #5e72e4;
    --pro-primary-dark: #324cdd;
    --pro-secondary: #8392ab;
    --pro-success: #2dce89;
    --pro-info: #11cdef;
    --pro-warning: #fb6340;
    --pro-danger: #f5365c;
    
    --pro-dark: #172b4d;
    --pro-dark-light: #212529;
    --pro-light: #f8f9fe;
    --pro-white: #ffffff;
    
    --pro-gray-100: #f6f9fc;
    --pro-gray-200: #e9ecef;
    --pro-gray-300: #dee2e6;
    --pro-gray-400: #ced4da;
    --pro-gray-500: #adb5bd;
    --pro-gray-600: #6c757d;
    --pro-gray-700: #495057;
    --pro-gray-800: #343a40;
    --pro-gray-900: #212529;
    
    --pro-font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    --pro-transition: all 0.15s ease;
    --pro-shadow: 0 0 2rem 0 rgba(136, 152, 170, 0.15);
    --pro-shadow-lg: 0 0.5rem 2rem 0 rgba(0, 0, 0, 0.1);
}

/* Main Sidebar Container */
.professional-sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: var(--pro-sidebar-width);
    height: 100vh;
    background: var(--pro-white);
    border-right: 1px solid var(--pro-gray-200);
    box-shadow: var(--pro-shadow);
    display: flex;
    flex-direction: column;
    font-family: var(--pro-font);
    z-index: 1000;
    overflow: hidden;
}

/* Brand Section */
.sidebar-brand {
    padding: 1.5rem 1.5rem 1rem;
    border-bottom: 1px solid var(--pro-gray-200);
    background: linear-gradient(87deg, var(--pro-primary) 0, var(--pro-primary-dark) 100%);
}

.brand-wrapper {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.brand-icon {
    width: 2.5rem;
    height: 2.5rem;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.brand-icon i {
    color: var(--pro-white);
    font-size: 1.25rem;
}

.brand-name {
    color: var(--pro-white);
    font-size: 1.125rem;
    font-weight: 600;
    line-height: 1.2;
    display: block;
}

.brand-subtitle {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* User Section */
.user-section {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--pro-gray-200);
}

.user-card {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: var(--pro-gray-100);
    border-radius: 0.5rem;
    transition: var(--pro-transition);
    cursor: pointer;
}

.user-card:hover {
    background: var(--pro-gray-200);
    transform: translateY(-1px);
}

.user-avatar {
    position: relative;
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
}

.user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-circle {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--pro-primary), var(--pro-info));
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--pro-white);
    font-weight: 600;
    font-size: 0.875rem;
}

.status-badge {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 0.75rem;
    height: 0.75rem;
    background: var(--pro-success);
    border: 2px solid var(--pro-white);
    border-radius: 50%;
}

.user-info {
    flex: 1;
    min-width: 0;
}

.user-name {
    color: var(--pro-gray-800);
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.125rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.user-role {
    color: var(--pro-gray-600);
    font-size: 0.75rem;
    font-weight: 500;
}

/* Navigation */
.sidebar-nav {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 0;
    scrollbar-width: thin;
    scrollbar-color: var(--pro-gray-300) transparent;
}

.sidebar-nav::-webkit-scrollbar {
    width: 6px;
}

.sidebar-nav::-webkit-scrollbar-track {
    background: transparent;
}

.sidebar-nav::-webkit-scrollbar-thumb {
    background: var(--pro-gray-300);
    border-radius: 3px;
}

.nav-content {
    padding: 0 1rem;
}

/* Navigation Groups */
.nav-group {
    margin-bottom: 1.5rem;
}

.group-title {
    color: var(--pro-gray-500);
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    margin-bottom: 0.5rem;
    padding: 0 0.75rem;
}

/* Navigation Items */
.nav-item {
    margin-bottom: 0.25rem;
}

.nav-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 0.75rem;
    color: var(--pro-gray-700);
    text-decoration: none;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: var(--pro-transition);
    border: none;
    background: none;
    width: 100%;
    cursor: pointer;
}

.nav-link:hover {
    background: var(--pro-gray-100);
    color: var(--pro-gray-900);
    text-decoration: none;
    transform: translateX(2px);
}

.nav-link.active {
    background: linear-gradient(135deg, rgba(94, 114, 228, 0.1), rgba(94, 114, 228, 0.05));
    color: var(--pro-primary);
    border-left: 3px solid var(--pro-primary);
    margin-left: -1rem;
    padding-left: calc(0.75rem + 1rem - 3px);
    font-weight: 600;
}

.nav-icon {
    width: 1.25rem;
    height: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
}

.nav-text {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Badges and Counters */
.pro-tag {
    background: linear-gradient(135deg, var(--pro-warning), var(--pro-danger));
    color: var(--pro-white);
    font-size: 0.625rem;
    font-weight: 700;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-left: auto;
    margin-right: 0.5rem;
}

.count-badge {
    background: var(--pro-gray-200);
    color: var(--pro-gray-600);
    font-size: 0.6875rem;
    font-weight: 600;
    padding: 0.125rem 0.375rem;
    border-radius: 0.75rem;
    min-width: 1.25rem;
    text-align: center;
    margin-left: auto;
    margin-right: 0.5rem;
}

.count-badge.urgent {
    background: var(--pro-danger);
    color: var(--pro-white);
}

/* Dropdowns */
.dropdown-nav .dropdown-btn {
    position: relative;
}

.dropdown-icon {
    margin-left: auto;
    font-size: 0.75rem;
    transition: transform 0.2s ease;
}

.dropdown-btn.expanded .dropdown-icon {
    transform: rotate(90deg);
}

.submenu {
    max-height: 0;
    overflow: hidden;
    margin-left: 2rem;
    transition: max-height 0.3s ease;
}

.submenu.open {
    max-height: 300px;
    padding: 0.25rem 0;
}

.submenu-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    color: var(--pro-gray-600);
    text-decoration: none;
    border-radius: 0.25rem;
    font-size: 0.8125rem;
    font-weight: 500;
    transition: var(--pro-transition);
    margin-bottom: 0.125rem;
}

.submenu-link:hover {
    background: var(--pro-gray-100);
    color: var(--pro-gray-800);
    text-decoration: none;
}

.submenu-icon {
    width: 1rem;
    height: 1rem;
    font-size: 0.75rem;
    flex-shrink: 0;
}

/* Subscription Section */
.subscription-section {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--pro-gray-200);
}

.subscription-card {
    background: linear-gradient(135deg, var(--pro-primary), var(--pro-primary-dark));
    border-radius: 0.75rem;
    padding: 1rem;
    color: var(--pro-white);
}

.subscription-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
}

.plan-icon {
    font-size: 1.25rem;
    color: var(--pro-warning);
}

.plan-name {
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.125rem;
}

.plan-usage {
    font-size: 0.75rem;
    opacity: 0.9;
}

.usage-progress {
    width: 100%;
    height: 0.25rem;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 0.125rem;
    overflow: hidden;
    margin-bottom: 0.75rem;
}

.progress-fill {
    height: 100%;
    background: var(--pro-white);
    border-radius: 0.125rem;
    transition: width 0.3s ease;
}

.upgrade-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--pro-white);
    text-decoration: none;
    font-size: 0.8125rem;
    font-weight: 600;
    opacity: 0.9;
    transition: opacity 0.2s ease;
}

.upgrade-btn:hover {
    opacity: 1;
    color: var(--pro-white);
    text-decoration: none;
}

/* Footer */
.sidebar-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--pro-gray-200);
}

.logout-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    color: var(--pro-danger);
    text-decoration: none;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: var(--pro-transition);
}

.logout-link:hover {
    background: rgba(245, 54, 92, 0.1);
    color: var(--pro-danger);
    text-decoration: none;
}

/* Responsive */
@media (max-width: 991.98px) {
    .professional-sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        z-index: 1001;
    }
    
    .professional-sidebar.show {
        transform: translateX(0);
    }
    
    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .sidebar-overlay.show {
        opacity: 1;
        visibility: visible;
    }
}

/* Layout Adjustments */
.medical-navbar,
.navbar {
    left: var(--pro-sidebar-width) !important;
    width: calc(100% - var(--pro-sidebar-width)) !important;
    z-index: 1001;
    transition: all 0.3s ease;
}

@media (max-width: 991.98px) {
    .medical-navbar,
    .navbar {
        left: 0 !important;
        width: 100% !important;
    }
}

.main-content {
    margin-left: var(--pro-sidebar-width);
    margin-top: 80px;
    transition: margin-left 0.3s ease;
}

@media (max-width: 991.98px) {
    .main-content {
        margin-left: 0;
        margin-top: 80px;
    }
}
</style>

<!-- Professional Sidebar JavaScript -->
<script>
function toggleProDropdown(moduleId) {
    console.log('Toggling dropdown:', moduleId);
    
    const dropdownNav = document.querySelector(`[data-module="${moduleId}"]`);
    if (!dropdownNav) {
        console.error('Dropdown not found:', moduleId);
        return;
    }
    
    const button = dropdownNav.querySelector('.dropdown-btn');
    const submenu = dropdownNav.querySelector('.submenu');
    
    if (!button || !submenu) {
        console.error('Button or submenu not found for:', moduleId);
        return;
    }
    
    // Close other dropdowns
    document.querySelectorAll('.dropdown-nav').forEach(item => {
        if (item !== dropdownNav) {
            const btn = item.querySelector('.dropdown-btn');
            const sub = item.querySelector('.submenu');
            if (btn && sub) {
                btn.classList.remove('expanded');
                sub.classList.remove('open');
            }
        }
    });
    
    // Toggle current dropdown
    const isOpen = submenu.classList.contains('open');
    if (isOpen) {
        button.classList.remove('expanded');
        submenu.classList.remove('open');
    } else {
        button.classList.add('expanded');
        submenu.classList.add('open');
    }
}

// Mobile sidebar toggle
function toggleMobileSidebar() {
    const sidebar = document.getElementById('professional-sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    
    if (sidebar && overlay) {
        sidebar.classList.toggle('show');
        overlay.classList.toggle('show');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('Professional sidebar initialized');
    
    // Close mobile sidebar when clicking overlay
    const overlay = document.getElementById('sidebar-overlay');
    if (overlay) {
        overlay.addEventListener('click', toggleMobileSidebar);
    }
});
</script>