{% extends 'base.html' %}
{% load static %}

{% block title %}Calendario de Citas - TopicTales Biomédica{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">Calendario de Citas</li>
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<style>
.fc-event {
    cursor: pointer;
}
.fc-daygrid-event {
    font-size: 0.85em;
}
.appointment-filters {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}
.quick-stats {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 15px 20px;
    margin-bottom: 20px;
}
.stat-item {
    text-align: center;
}
.stat-number {
    font-size: 2rem;
    font-weight: bold;
    display: block;
}
.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

/* Calendar view improvements */
.fc-timegrid-slot-minor {
    border-top: 1px dotted #ddd;
}

.fc-timegrid-slot-label {
    font-weight: 500;
    color: #666;
}

.fc-col-header {
    background-color: #f8f9fa;
    font-weight: 600;
}

.fc-day-today {
    background-color: rgba(13, 110, 253, 0.1) !important;
}

.fc-event {
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    font-size: 12px;
    font-weight: 500;
}

.fc-event:hover {
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

.fc-timegrid-event {
    margin: 1px 2px;
}

.fc-button-group .fc-button {
    font-weight: 500;
}

.fc-toolbar-title {
    font-weight: 600;
    color: #495057;
}

/* Business hours styling */
.fc-non-business {
    background-color: rgba(0,0,0,0.03);
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Calendar Controls -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-event me-2"></i>Calendario de Citas
                    </h5>
                    <div class="btn-group" role="group">
                        <a href="{% url 'appointments:create' %}" class="btn btn-primary">
                            <i class="bi bi-plus-lg me-1"></i>Nueva Cita
                        </a>
                        <button type="button" class="btn btn-success" id="quick-appointment-btn">
                            <i class="bi bi-lightning me-1"></i>Cita Rápida
                        </button>
                        <a href="{% url 'appointments:list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-list-ul me-1"></i>Ver Lista
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="card-body pb-0">
                <div class="quick-stats">
                    <div class="row">
                        <div class="col-md-3 stat-item">
                            <span class="stat-number">{{ today_appointments }}</span>
                            <span class="stat-label">Citas Hoy</span>
                        </div>
                        <div class="col-md-3 stat-item">
                            <span class="stat-number" id="week-appointments">-</span>
                            <span class="stat-label">Esta Semana</span>
                        </div>
                        <div class="col-md-3 stat-item">
                            <span class="stat-number" id="month-appointments">-</span>
                            <span class="stat-label">Este Mes</span>
                        </div>
                        <div class="col-md-3 stat-item">
                            <span class="stat-number" id="pending-appointments">-</span>
                            <span class="stat-label">Pendientes</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="card-body">
                <div class="appointment-filters">
                    <form method="get" id="filter-form">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Médico</label>
                                <select name="doctor" class="form-select" id="doctor-filter">
                                    <option value="">Todos los médicos</option>
                                    {% for doctor in doctors %}
                                        <option value="{{ doctor.id }}">{{ doctor.get_full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Tipo de Cita</label>
                                <select name="appointment_type" class="form-select" id="type-filter">
                                    <option value="">Todos los tipos</option>
                                    {% for type in appointment_types %}
                                        <option value="{{ type.id }}">{{ type.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Estado</label>
                                <select name="status" class="form-select" id="status-filter">
                                    <option value="">Todos los estados</option>
                                    <option value="scheduled">Programada</option>
                                    <option value="confirmed">Confirmada</option>
                                    <option value="in_progress">En progreso</option>
                                    <option value="completed">Completada</option>
                                    <option value="cancelled">Cancelada</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="button" class="btn btn-outline-primary me-2" id="apply-filters">
                                    <i class="bi bi-funnel me-1"></i>Filtrar
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="clear-filters">
                                    <i class="bi bi-x-lg me-1"></i>Limpiar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Calendar -->
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- Appointment Detail Modal -->
<div class="modal fade" id="appointmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle de Cita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="appointment-details">
                    <!-- Content loaded via AJAX -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <a href="#" class="btn btn-primary" id="view-appointment">Ver Completo</a>
            </div>
        </div>
    </div>
</div>

<!-- Quick Appointment Modal -->
<div class="modal fade" id="quickAppointmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crear Cita Rápida</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="quick-appointment-form">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Paciente *</label>
                        <select name="patient" class="form-select" required>
                            <option value="">Seleccionar paciente...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo de Cita *</label>
                        <select name="appointment_type" class="form-select" required>
                            <option value="">Seleccionar tipo...</option>
                            {% for type in appointment_types %}
                                <option value="{{ type.id }}">{{ type.name }} ({{ type.duration_minutes }} min)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Motivo de la Consulta *</label>
                        <input type="text" name="reason" class="form-control" placeholder="Motivo de la consulta" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Fecha y Hora *</label>
                        <input type="datetime-local" name="appointment_datetime" id="selected-datetime" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Cita</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    let calendar;
    let selectedDate = null;
    let selectedDoctor = null;
    
    console.log('Initializing FullCalendar...');
    
    // Initialize FullCalendar v6 with correct syntax
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        views: {
            timeGridWeek: {
                slotMinTime: '06:00:00',
                slotMaxTime: '22:00:00',
                slotDuration: '00:30:00'
            },
            timeGridDay: {
                slotMinTime: '06:00:00',
                slotMaxTime: '22:00:00',
                slotDuration: '00:30:00'
            }
        },
        buttonText: {
            today: 'Hoy',
            month: 'Mes', 
            week: 'Semana',
            day: 'Día'
        },
        height: 'auto',
        selectable: true,
        editable: true,
        dayMaxEvents: true,
        nowIndicator: true,
        
        businessHours: {
            startTime: '08:00',
            endTime: '18:00',
            daysOfWeek: [1, 2, 3, 4, 5]
        },
        
        // Event sources
        events: {
            url: '{% url "appointments:calendar_events" %}',
            method: 'GET',
            extraParams: function() {
                const params = {
                    doctor_id: document.getElementById('doctor-filter').value,
                    appointment_type_id: document.getElementById('type-filter').value,
                    status: document.getElementById('status-filter').value
                };
                console.log('Loading calendar events with params:', params);
                return params;
            },
            success: function(events) {
                console.log('Calendar events loaded successfully:', events.length, 'events');
            },
            failure: function(error) {
                console.error('Error loading calendar events:', error);
                alert('Error al cargar las citas del calendario');
            }
        },
        
        // Event handlers
        eventClick: function(info) {
            showAppointmentDetails(info.event.id);
        },
        
        select: function(info) {
            selectedDate = info.start;
            selectedDoctor = document.getElementById('doctor-filter').value;
            
            if (selectedDoctor) {
                openQuickAppointmentModal(info.start, selectedDoctor);
            } else {
                alert('Por favor selecciona un médico primero');
                calendar.unselect();
            }
        },
        
        eventDrop: function(info) {
            updateAppointmentTime(info.event.id, info.event.start, info.event.end);
        },
        
        eventResize: function(info) {
            updateAppointmentTime(info.event.id, info.event.start, info.event.end);
        },
        
        // Debug view changes
        datesSet: function(info) {
            console.log('View changed to:', info.view.type);
            console.log('Date range:', info.start, 'to', info.end);
        }
    });
    
    // Render calendar with error handling
    try {
        calendar.render();
        console.log('FullCalendar rendered successfully');
        console.log('Current view:', calendar.view.type);
        
        // Add manual button click handlers as backup
        setTimeout(() => {
            const buttons = document.querySelectorAll('.fc-button');
            console.log('FullCalendar buttons found:', buttons.length);
            buttons.forEach((btn, index) => {
                console.log(`Button ${index}:`, btn.textContent, btn.className);
                
                // Add click event listener for debugging
                btn.addEventListener('click', function() {
                    console.log('Button clicked:', btn.textContent);
                    setTimeout(() => {
                        console.log('New view after click:', calendar.view.type);
                    }, 100);
                });
            });
        }, 1000);
        
    } catch (error) {
        console.error('Error rendering FullCalendar:', error);
    }
    
    // Filter handlers
    document.getElementById('apply-filters').addEventListener('click', function() {
        console.log('Applying filters...');
        calendar.refetchEvents();
        updateStats();
    });
    
    document.getElementById('clear-filters').addEventListener('click', function() {
        console.log('Clearing filters...');
        document.getElementById('filter-form').reset();
        calendar.refetchEvents();
        updateStats();
    });
    
    // Auto-apply filters when changed
    ['doctor-filter', 'type-filter', 'status-filter'].forEach(function(id) {
        document.getElementById(id).addEventListener('change', function() {
            console.log(`Filter ${id} changed, refreshing events...`);
            calendar.refetchEvents();
        });
    });
    
    // Show appointment details
    function showAppointmentDetails(appointmentId) {
        fetch(`{% url "appointments:appointment_details_ajax" appointment_id=0 %}`.replace('0', appointmentId))
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const appointment = result.appointment;
                    const detailsHtml = `
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card border-0">
                                    <div class="card-body p-0">
                                        <h6 class="text-primary mb-3">
                                            <i class="bi bi-person-circle me-2"></i>Información del Paciente
                                        </h6>
                                        <div class="row mb-3">
                                            <div class="col-sm-4"><strong>Paciente:</strong></div>
                                            <div class="col-sm-8">${appointment.patient_name}</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-4"><strong>ID Paciente:</strong></div>
                                            <div class="col-sm-8">${appointment.patient_id}</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-4"><strong>Teléfono:</strong></div>
                                            <div class="col-sm-8">${appointment.patient_phone || 'No especificado'}</div>
                                        </div>
                                        
                                        <hr class="my-3">
                                        
                                        <h6 class="text-success mb-3">
                                            <i class="bi bi-calendar-event me-2"></i>Detalles de la Cita
                                        </h6>
                                        <div class="row mb-3">
                                            <div class="col-sm-4"><strong>Médico:</strong></div>
                                            <div class="col-sm-8">${appointment.doctor_name}</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-4"><strong>Tipo:</strong></div>
                                            <div class="col-sm-8">${appointment.appointment_type}</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-4"><strong>Fecha y Hora:</strong></div>
                                            <div class="col-sm-8">${appointment.start_datetime}</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-4"><strong>Duración:</strong></div>
                                            <div class="col-sm-8">${appointment.duration} minutos</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-4"><strong>Motivo:</strong></div>
                                            <div class="col-sm-8">${appointment.reason}</div>
                                        </div>
                                        ${appointment.notes ? `
                                        <div class="row mb-3">
                                            <div class="col-sm-4"><strong>Notas:</strong></div>
                                            <div class="col-sm-8">${appointment.notes}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light border-0">
                                    <div class="card-body">
                                        <h6 class="text-info mb-3">
                                            <i class="bi bi-info-circle me-2"></i>Estado
                                        </h6>
                                        <div class="mb-3">
                                            <span class="badge bg-${appointment.status_class} fs-6">${appointment.status}</span>
                                        </div>
                                        <div class="mb-3">
                                            <small class="text-muted">Prioridad:</small><br>
                                            <strong>${appointment.priority}</strong>
                                        </div>
                                        ${appointment.amount_charged ? `
                                        <div class="mb-3">
                                            <small class="text-muted">Costo:</small><br>
                                            <strong>$${appointment.amount_charged}</strong>
                                        </div>
                                        ` : ''}
                                        ${appointment.payment_method ? `
                                        <div class="mb-3">
                                            <small class="text-muted">Método de pago:</small><br>
                                            <strong>${appointment.payment_method}</strong>
                                        </div>
                                        ` : ''}
                                        ${appointment.has_consultation_note ? `
                                        <div class="alert alert-success py-2">
                                            <i class="bi bi-file-medical me-2"></i>
                                            <small>Tiene nota de consulta</small>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('appointment-details').innerHTML = detailsHtml;
                    document.getElementById('view-appointment').href = `/appointments/${appointmentId}/`;
                    new bootstrap.Modal(document.getElementById('appointmentModal')).show();
                } else {
                    alert('Error al cargar los detalles de la cita');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar los detalles de la cita');
            });
    }
    
    // Open quick appointment modal
    function openQuickAppointmentModal(date = null, doctorId = null) {
        const modal = new bootstrap.Modal(document.getElementById('quickAppointmentModal'));
        const datetimeInput = document.getElementById('selected-datetime');
        
        // Set selected datetime or current time
        let targetDate;
        if (date) {
            targetDate = date;
        } else {
            const now = new Date();
            now.setMinutes(Math.ceil(now.getMinutes() / 15) * 15); // Round to next 15 min
            targetDate = now;
        }
        
        selectedDate = targetDate;
        
        // Format for datetime-local input (YYYY-MM-DDTHH:mm)
        const year = targetDate.getFullYear();
        const month = String(targetDate.getMonth() + 1).padStart(2, '0');
        const day = String(targetDate.getDate()).padStart(2, '0');
        const hours = String(targetDate.getHours()).padStart(2, '0');
        const minutes = String(targetDate.getMinutes()).padStart(2, '0');
        
        datetimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        
        // Set selected doctor
        if (doctorId) {
            selectedDoctor = doctorId;
        } else {
            selectedDoctor = document.getElementById('doctor-filter').value;
        }
        
        // Load patients
        loadPatients();
        
        modal.show();
    }
    
    // Quick appointment button handler
    document.getElementById('quick-appointment-btn').addEventListener('click', function() {
        openQuickAppointmentModal();
    });
    
    // Debug function to check all appointments
    window.debugAppointments = function() {
        fetch('{% url "appointments:calendar_events" %}')
            .then(response => response.json())
            .then(events => {
                console.log('All appointments in database:', events);
                events.forEach(event => {
                    console.log(`- ${event.title} at ${event.start}`);
                });
            })
            .catch(error => {
                console.error('Error fetching appointments:', error);
            });
    };
    
    // Load patients for quick appointment
    function loadPatients() {
        const patientSelect = document.querySelector('#quickAppointmentModal select[name="patient"]');
        patientSelect.innerHTML = '<option value="">Cargando pacientes...</option>';
        
        // Get patients via AJAX
        fetch('/patients/api/list/')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.patients) {
                    let options = '<option value="">Seleccionar paciente...</option>';
                    data.patients.forEach(patient => {
                        options += `<option value="${patient.id}">${patient.full_name}</option>`;
                    });
                    patientSelect.innerHTML = options;
                } else {
                    // Fallback to manual options if API doesn't exist
                    patientSelect.innerHTML = `
                        <option value="">Seleccionar paciente...</option>
                        {% for patient in patients %}
                            <option value="{{ patient.id }}">{{ patient.get_full_name }}</option>
                        {% endfor %}
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading patients:', error);
                // Fallback to manual options
                patientSelect.innerHTML = `
                    <option value="">Seleccionar paciente...</option>
                    {% for patient in patients %}
                        <option value="{{ patient.id }}">{{ patient.get_full_name }}</option>
                    {% endfor %}
                `;
            });
    }
    
    // Handle quick appointment form submission
    document.getElementById('quick-appointment-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const patientId = formData.get('patient');
        const appointmentTypeId = formData.get('appointment_type');
        const reason = formData.get('reason');
        const appointmentDatetime = formData.get('appointment_datetime');
        
        // Validate required fields
        if (!patientId) {
            alert('Por favor selecciona un paciente');
            return;
        }
        if (!selectedDoctor) {
            alert('Por favor selecciona un médico primero');
            return;
        }
        if (!appointmentTypeId) {
            alert('Por favor selecciona un tipo de cita');
            return;
        }
        if (!reason.trim()) {
            alert('Por favor ingresa el motivo de la consulta');
            return;
        }
        if (!appointmentDatetime) {
            alert('Por favor selecciona una fecha y hora');
            return;
        }
        
        // Parse the datetime from the input
        selectedDate = new Date(appointmentDatetime);
        
        const data = {
            patient_id: patientId,
            doctor_id: selectedDoctor,
            appointment_type_id: appointmentTypeId,
            start_datetime: selectedDate.toISOString(),
            reason: reason.trim()
        };
        
        console.log('Sending appointment data:', data);
        
        // Disable submit button during request
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creando...';
        
        fetch('{% url "appointments:quick_appointment" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(result => {
            console.log('Response data:', result);
            if (result.success) {
                console.log('Quick appointment created successfully, refreshing calendar...');
                
                // Close modal and reset form
                bootstrap.Modal.getInstance(document.getElementById('quickAppointmentModal')).hide();
                document.getElementById('quick-appointment-form').reset();
                selectedDate = null;
                selectedDoctor = null;
                
                // Refresh calendar events - different method for v5
                calendar.refetchEvents();
                
                // Also try alternative refresh methods
                setTimeout(() => {
                    console.log('Secondary refresh attempt...');
                    calendar.refetchEvents();
                }, 500);
                
                // Additional verification - check if appointment was created
                setTimeout(() => {
                    console.log('Verifying appointment creation...');
                    fetch(`{% url "appointments:appointment_details_ajax" appointment_id=0 %}`.replace('0', result.appointment_id))
                        .then(response => response.json())
                        .then(verifyResult => {
                            if (verifyResult.success) {
                                console.log('Appointment verified in database:', verifyResult.appointment);
                            } else {
                                console.error('Appointment not found in database after creation');
                            }
                        })
                        .catch(error => {
                            console.error('Error verifying appointment:', error);
                        });
                }, 1000);
                
                showNotification('Cita creada exitosamente', 'success');
            } else {
                alert('Error al crear la cita: ' + (result.message || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error creating appointment:', error);
            alert('Error de conexión al crear la cita');
        })
        .finally(() => {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        });
    });
    
    // Update appointment time (drag & drop)
    function updateAppointmentTime(appointmentId, newStart, newEnd) {
        fetch('{% url "appointments:update_appointment_time" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                appointment_id: appointmentId,
                start_datetime: newStart.toISOString(),
                end_datetime: newEnd ? newEnd.toISOString() : null
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Show success notification
                showNotification('Cita movida exitosamente', 'success');
            } else {
                alert('Error al actualizar la cita: ' + result.message);
                calendar.refetchEvents(); // Revert changes
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexión al actualizar la cita');
            calendar.refetchEvents(); // Revert changes
        });
    }
    
    // Update statistics
    function updateStats() {
        // This would typically make AJAX calls to get updated statistics
        // For now, we'll use placeholder values
        document.getElementById('week-appointments').textContent = '15';
        document.getElementById('month-appointments').textContent = '85';
        document.getElementById('pending-appointments').textContent = '8';
    }
    
    // Initial stats load
    updateStats();
    
    // Utility functions
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
    
    // Add confirmation for drag & drop
    let draggedEvent = null;
    
    calendar.on('eventDragStart', function(info) {
        draggedEvent = info.event;
    });
    
    calendar.on('eventDrop', function(info) {
        const confirmed = confirm(`¿Deseas mover la cita de ${draggedEvent.title} a ${info.event.start.toLocaleString('es-MX')}?`);
        if (!confirmed) {
            info.revert();
        }
    });
    
    calendar.on('eventResizeStart', function(info) {
        draggedEvent = info.event;
    });
    
    calendar.on('eventResize', function(info) {
        const startTime = info.event.start.toLocaleString('es-MX');
        const endTime = info.event.end.toLocaleString('es-MX');
        const confirmed = confirm(`¿Deseas cambiar la duración de la cita de ${draggedEvent.title} de ${startTime} a ${endTime}?`);
        if (!confirmed) {
            info.revert();
        }
    });
});
</script>
{% endblock %}