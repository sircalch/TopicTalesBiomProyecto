{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'specialties:index' %}">Especialidades</a></li>
<li class="breadcrumb-item"><a href="{% url 'specialties:consultation_list' %}">Consultas</a></li>
<li class="breadcrumb-item active">{{ consultation.specialty.name }} - {{ consultation.patient.get_full_name }}</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header Section -->
            <div class="card border-0 shadow-sm bg-gradient mb-4" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);">
                <div class="card-body text-white py-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <div class="consultation-icon me-4">
                                    <i class="fas fa-file-medical fa-3x"></i>
                                </div>
                                <div>
                                    <h1 class="h2 mb-1">{{ title }}</h1>
                                    <p class="mb-1 opacity-75">{{ consultation.specialty.name }} - {{ consultation.patient.get_full_name }}</p>
                                    <small class="opacity-75">{{ consultation.date|date:"d/m/Y H:i" }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex gap-2 justify-content-end">
                                <a href="{% url 'specialties:consultation_list' %}" class="btn btn-light btn-sm">
                                    <i class="fas fa-arrow-left me-1"></i>Volver
                                </a>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-light btn-sm" onclick="editConsultation()">
                                        <i class="fas fa-edit me-1"></i>Editar
                                    </button>
                                    <button class="btn btn-outline-light btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="printConsultation()">
                                            <i class="fas fa-print me-2"></i>Imprimir
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="exportToPDF()">
                                            <i class="fas fa-file-pdf me-2"></i>Exportar PDF
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" href="#" onclick="addFollowUp()">
                                            <i class="fas fa-calendar-plus me-2"></i>Agendar Seguimiento
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="createReferral()">
                                            <i class="fas fa-share me-2"></i>Crear Referencia
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Patient Information -->
                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-user me-2"></i>Información del Paciente
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <img src="https://via.placeholder.com/60x60/007bff/ffffff?text={{ consultation.patient.get_full_name|first }}" 
                                     class="rounded-circle me-3" width="60" height="60" alt="Patient Avatar">
                                <div>
                                    <h6 class="fw-bold mb-1">{{ consultation.patient.get_full_name }}</h6>
                                    <small class="text-muted">ID: {{ consultation.patient.patient_id|default:consultation.patient.document_number }}</small>
                                </div>
                            </div>
                            <div class="patient-info">
                                <div class="info-item d-flex justify-content-between py-2 border-bottom">
                                    <span class="text-muted">Documento:</span>
                                    <span class="fw-medium">{{ consultation.patient.document_number }}</span>
                                </div>
                                <div class="info-item d-flex justify-content-between py-2 border-bottom">
                                    <span class="text-muted">Edad:</span>
                                    <span class="fw-medium">{{ consultation.patient.get_age }} años</span>
                                </div>
                                <div class="info-item d-flex justify-content-between py-2 border-bottom">
                                    <span class="text-muted">Género:</span>
                                    <span class="fw-medium">{{ consultation.patient.get_gender_display|default:"No especificado" }}</span>
                                </div>
                                <div class="info-item d-flex justify-content-between py-2 border-bottom">
                                    <span class="text-muted">Teléfono:</span>
                                    <span class="fw-medium">{{ consultation.patient.phone_number|default:"No registrado" }}</span>
                                </div>
                                <div class="info-item d-flex justify-content-between py-2">
                                    <span class="text-muted">Email:</span>
                                    <span class="fw-medium">{{ consultation.patient.email|default:"No registrado" }}</span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <a href="{% url 'patients:detail' consultation.patient.pk %}" class="btn btn-outline-primary btn-sm w-100">
                                    <i class="fas fa-user me-2"></i>Ver Expediente Completo
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Doctor Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-user-md me-2"></i>Doctor Tratante
                            </h5>
                        </div>
                        <div class="card-body">
                            <h6 class="fw-bold">{{ consultation.doctor.user.get_full_name }}</h6>
                            <p class="mb-2"><strong>Especialidad:</strong> {{ consultation.specialty.name }}</p>
                            <p class="mb-2"><strong>Licencia:</strong> {{ consultation.doctor.license_number }}</p>
                            <p class="mb-0"><strong>Experiencia:</strong> {{ consultation.doctor.years_experience }} años</p>
                        </div>
                    </div>
                </div>

                <!-- Consultation Details -->
                <div class="col-md-8">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-notes-medical me-2"></i>Detalles de la Consulta
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <p><strong>Fecha:</strong> {{ consultation.date|date:"d/m/Y H:i" }}</p>
                                    <p><strong>Especialidad:</strong> {{ consultation.specialty.name }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Estado:</strong>
                                        {% if consultation.is_completed %}
                                            <span class="badge bg-success">Completada</span>
                                        {% else %}
                                            <span class="badge bg-warning">Pendiente</span>
                                        {% endif %}
                                    </p>
                                    <p><strong>Tipo:</strong> 
                                        {% if consultation.consultation_type == 'first_time' %}
                                            Primera vez
                                        {% elif consultation.consultation_type == 'follow_up' %}
                                            Control
                                        {% else %}
                                            Regular
                                        {% endif %}
                                    </p>
                                </div>
                            </div>

                            <hr>

                            <div class="mb-4">
                                <h6 class="fw-bold">Motivo de Consulta</h6>
                                <p class="mb-0">{{ consultation.chief_complaint|default:"No especificado" }}</p>
                            </div>

                            {% if consultation.history_present_illness %}
                            <div class="mb-4">
                                <h6 class="fw-bold">Historia de la Enfermedad Actual</h6>
                                <p class="mb-0">{{ consultation.history_present_illness }}</p>
                            </div>
                            {% endif %}

                            {% if consultation.physical_examination %}
                            <div class="mb-4">
                                <h6 class="fw-bold">Examen Físico</h6>
                                <p class="mb-0">{{ consultation.physical_examination }}</p>
                            </div>
                            {% endif %}

                            {% if consultation.diagnosis %}
                            <div class="mb-4">
                                <h6 class="fw-bold">Diagnóstico</h6>
                                <p class="mb-0">{{ consultation.diagnosis }}</p>
                            </div>
                            {% endif %}

                            {% if consultation.treatment_plan %}
                            <div class="mb-4">
                                <h6 class="fw-bold">Plan de Tratamiento</h6>
                                <p class="mb-0">{{ consultation.treatment_plan }}</p>
                            </div>
                            {% endif %}

                            {% if consultation.notes %}
                            <div class="mb-4">
                                <h6 class="fw-bold">Notas Adicionales</h6>
                                <p class="mb-0">{{ consultation.notes }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Associated Treatments -->
                    {% if treatments %}
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-prescription me-2"></i>Tratamientos Asociados
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Tratamiento</th>
                                            <th>Fecha Inicio</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for treatment in treatments %}
                                        <tr>
                                            <td>
                                                <strong>{{ treatment.name }}</strong><br>
                                                <small class="text-muted">{{ treatment.description|truncatechars:50 }}</small>
                                            </td>
                                            <td>{{ treatment.start_date|date:"d/m/Y" }}</td>
                                            <td>
                                                {% if treatment.status == 'in_progress' %}
                                                    <span class="badge bg-info">En Progreso</span>
                                                {% elif treatment.status == 'completed' %}
                                                    <span class="badge bg-success">Completado</span>
                                                {% elif treatment.status == 'cancelled' %}
                                                    <span class="badge bg-danger">Cancelado</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ treatment.status }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{% url 'specialties:treatment_detail' treatment.pk %}" class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.bg-gradient {
    background: linear-gradient(135deg, var(--bs-primary) 0%, var(--bs-primary-dark) 100%);
}

.consultation-icon {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.patient-info .info-item {
    transition: background-color 0.2s ease;
}

.patient-info .info-item:hover {
    background-color: #f8f9fa;
    margin: 0 -15px;
    padding-left: 15px !important;
    padding-right: 15px !important;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.consultation-section {
    border-left: 4px solid #007bff;
    padding-left: 15px;
    margin-bottom: 20px;
}

.vital-signs {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.vital-item {
    text-align: center;
    padding: 10px;
    border-right: 1px solid #dee2e6;
}

.vital-item:last-child {
    border-right: none;
}

.vital-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #007bff;
}

.vital-label {
    font-size: 0.8rem;
    color: #6c757d;
    text-transform: uppercase;
}

@media (max-width: 768px) {
    .consultation-icon {
        display: none;
    }
    
    .d-flex.gap-2 {
        flex-direction: column;
        gap: 0.5rem !important;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Consultation Detail Functions
function editConsultation() {
    TopicTalesApp.utils.confirm(
        '¿Desea editar esta consulta?',
        function() {
            window.location.href = '{% url "specialties:edit_consultation" consultation.pk %}';
        }
    );
}

function printConsultation() {
    TopicTalesApp.utils.showLoading('Preparando impresión...');
    
    setTimeout(() => {
        TopicTalesApp.utils.hideLoading();
        
        // Create print-friendly content
        const printContent = `
            <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto;">
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #007bff; padding-bottom: 20px;">
                    <h1 style="color: #007bff; margin: 0;">TopicTales Biomédica</h1>
                    <h2 style="margin: 10px 0; color: #333;">Consulta de ${consultation.specialty.name}</h2>
                    <p style="margin: 0; color: #666;">Fecha: ${consultation.date}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div>
                        <h3 style="color: #007bff; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">Información del Paciente</h3>
                        <p><strong>Nombre:</strong> ${consultation.patient.full_name}</p>
                        <p><strong>Documento:</strong> ${consultation.patient.document_number}</p>
                        <p><strong>Edad:</strong> ${consultation.patient.age} años</p>
                    </div>
                    <div>
                        <h3 style="color: #007bff; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">Doctor Tratante</h3>
                        <p><strong>Nombre:</strong> ${consultation.doctor.full_name}</p>
                        <p><strong>Especialidad:</strong> ${consultation.specialty.name}</p>
                        <p><strong>Licencia:</strong> ${consultation.doctor.license_number}</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #007bff; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">Motivo de Consulta</h3>
                    <p style="text-align: justify;">${consultation.chief_complaint}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #007bff; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">Diagnóstico</h3>
                    <p style="text-align: justify;">${consultation.diagnosis}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #007bff; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">Plan de Tratamiento</h3>
                    <p style="text-align: justify;">${consultation.treatment_plan}</p>
                </div>
                
                <div style="margin-top: 50px; text-align: center; border-top: 1px solid #dee2e6; padding-top: 20px;">
                    <p style="margin: 0; color: #666; font-size: 0.9rem;">
                        Documento generado el ${new Date().toLocaleDateString('es-ES')} a las ${new Date().toLocaleTimeString('es-ES')}
                    </p>
                </div>
            </div>
        `;
        
        // Open print window
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>Consulta - ${consultation.patient.full_name}</title>
                    <style>
                        body { margin: 20px; font-size: 14px; line-height: 1.6; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <script>
                        window.onload = function() {
                            window.print();
                            window.close();
                        }
                    </script>
                </body>
            </html>
        `);
        printWindow.document.close();
    }, 1500);
}

function exportToPDF() {
    TopicTalesApp.utils.showLoading('Generando PDF...');
    
    setTimeout(() => {
        TopicTalesApp.utils.hideLoading();
        TopicTalesApp.utils.showToast('PDF generado exitosamente', 'success');
        
        // Simulate PDF download
        const link = document.createElement('a');
        link.href = 'data:application/pdf;base64,JVBERi0xLjQKJdPr6eEKMSAwIG9iago8PAovVGl0bGUgKP7/AEMAbwBuAHMAdQBsAHQAYQAgAC0AIAB7AHsAIABjAG8AbgBzAHUAbAB0AGEAdABpAG8AbgAuAHAAYQB0AGkAZQBuAHQALgBmAHUAbABsAF8AbgBhAG0AZQAgAH0AfQAp...';
        link.download = `consulta_${consultation.patient.full_name.replace(/\\s/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
        link.click();
    }, 2000);
}

function addFollowUp() {
    TopicTalesApp.utils.confirm(
        '¿Desea agendar una consulta de seguimiento?',
        function() {
            TopicTalesApp.utils.showToast('Redirigiendo al calendario de citas...', 'info');
            setTimeout(() => {
                window.location.href = `/appointments/create/?patient=${consultation.patient.id}&type=follow_up&specialty=${consultation.specialty.id}`;
            }, 1000);
        }
    );
}

function createReferral() {
    TopicTalesApp.utils.confirm(
        '¿Desea crear una referencia a otra especialidad?',
        function() {
            TopicTalesApp.utils.showToast('Abriendo formulario de referencia...', 'info');
            setTimeout(() => {
                window.location.href = '{% url "specialties:create_referral" %}?consultation={{ consultation.pk }}';
            }, 1000);
        }
    );
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Add hover effects to cards
    const cards = document.querySelectorAll('.card');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            if (!this.classList.contains('bg-gradient')) {
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 0.5rem 1rem rgba(0, 0, 0, 0.15)';
            }
        });
        
        card.addEventListener('mouseleave', function() {
            if (!this.classList.contains('bg-gradient')) {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '';
            }
        });
    });
    
    // Smooth scrolling for internal links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});
</script>
{% endblock %}