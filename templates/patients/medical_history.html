{% extends 'base.html' %}
{% load static %}

{% block title %}Historia Médica - TopicTales Biomédica{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'patients:list' %}">Pacientes</a></li>
<li class="breadcrumb-item active">Historia Médica</li>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-medical me-2"></i>Historia Médica del Paciente
                </h5>
            </div>
            <div class="card-body">
                <!-- Medical History Timeline -->
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                            <h6 class="timeline-title">Consulta General - 25/07/2025</h6>
                            <p class="text-muted mb-2">Dr. García López</p>
                            <div class="timeline-body">
                                <p><strong>Motivo:</strong> Control de rutina anual</p>
                                <p><strong>Diagnóstico:</strong> Estado de salud óptimo</p>
                                <p><strong>Tratamiento:</strong> Continuar con hábitos saludables</p>
                                <p><strong>Observaciones:</strong> Paciente presenta buen estado general. Se recomienda mantener actividad física regular.</p>
                            </div>
                            <div class="timeline-footer">
                                <span class="badge bg-success">Completada</span>
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="viewConsultation(1)">Ver Detalles</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-marker bg-warning"></div>
                        <div class="timeline-content">
                            <h6 class="timeline-title">Análisis de Laboratorio - 20/07/2025</h6>
                            <p class="text-muted mb-2">Laboratorio Central</p>
                            <div class="timeline-body">
                                <p><strong>Tipo:</strong> Perfil lipídico completo</p>
                                <p><strong>Resultados:</strong> Valores dentro de rangos normales</p>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <small>• Colesterol Total: 180 mg/dl</small><br>
                                        <small>• HDL: 55 mg/dl</small><br>
                                        <small>• LDL: 110 mg/dl</small>
                                    </div>
                                    <div class="col-md-6">
                                        <small>• Triglicéridos: 120 mg/dl</small><br>
                                        <small>• Glucosa: 95 mg/dl</small>
                                    </div>
                                </div>
                            </div>
                            <div class="timeline-footer">
                                <span class="badge bg-info">Laboratorio</span>
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="viewLabResults(1)">Ver Análisis</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-marker bg-danger"></div>
                        <div class="timeline-content">
                            <h6 class="timeline-title">Consulta de Emergencia - 15/06/2025</h6>
                            <p class="text-muted mb-2">Dr. Martínez Ruiz</p>
                            <div class="timeline-body">
                                <p><strong>Motivo:</strong> Dolor abdominal agudo</p>
                                <p><strong>Diagnóstico:</strong> Gastritis aguda</p>
                                <p><strong>Tratamiento:</strong> Omeprazol 20mg, dieta blanda</p>
                                <p><strong>Evolución:</strong> Mejoría completa en 48 horas</p>
                            </div>
                            <div class="timeline-footer">
                                <span class="badge bg-success">Resuelta</span>
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="viewConsultation(2)">Ver Detalles</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Add New Entry -->
                <div class="mt-4 pt-3 border-top">
                    <h6 class="mb-3">Añadir Nueva Entrada</h6>
                    <button class="btn btn-primary me-2" onclick="addConsultation()">
                        <i class="fas fa-plus me-1"></i>Nueva Consulta
                    </button>
                    <button class="btn btn-outline-primary me-2" onclick="addLabResult()">
                        <i class="fas fa-flask me-1"></i>Resultado de Laboratorio
                    </button>
                    <button class="btn btn-outline-secondary" onclick="addNote()">
                        <i class="fas fa-sticky-note me-1"></i>Nota Médica
                    </button>
                </div>
                
                <div class="mt-3">
                    <a href="{% url 'patients:list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Volver a Lista
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline:before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}

.timeline-item {
    position: relative;
    margin-bottom: 30px;
}

.timeline-marker {
    position: absolute;
    left: -22px;
    top: 5px;
    width: 15px;
    height: 15px;
    border-radius: 50%;
    border: 3px solid #fff;
    box-shadow: 0 0 0 2px #e9ecef;
}

.timeline-content {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.timeline-title {
    color: #495057;
    margin-bottom: 5px;
}

.timeline-footer {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function viewConsultation(id) {
    const consultationData = {
        1: {
            title: "Consulta General - 25/07/2025",
            doctor: "Dr. García López",
            time: "10:30",
            reason: "Control de rutina anual",
            diagnosis: "Estado de salud óptimo",
            treatment: "Continuar con hábitos saludables",
            observations: "Paciente presenta buen estado general. Se recomienda mantener actividad física regular y dieta balanceada.",
            vitals: "PA: 120/80, FC: 72 bpm, Temp: 36.5°C, Peso: 70kg",
            nextAppointment: "25/01/2026"
        },
        2: {
            title: "Consulta de Emergencia - 15/06/2025",
            doctor: "Dr. Martínez Ruiz",
            time: "14:45",
            reason: "Dolor abdominal agudo",
            diagnosis: "Gastritis aguda",
            treatment: "Omeprazol 20mg cada 12 horas por 14 días, dieta blanda",
            observations: "Paciente con dolor epigástrico de 6 horas de evolución. Mejoría completa en 48 horas.",
            vitals: "PA: 130/85, FC: 85 bpm, Temp: 36.8°C",
            nextAppointment: "Seguimiento en 1 semana"
        }
    };
    
    const data = consultationData[id] || consultationData[1];
    
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">${data.title}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Información de la Consulta</h6>
                            <div class="mb-2"><strong>Médico:</strong> ${data.doctor}</div>
                            <div class="mb-2"><strong>Hora:</strong> ${data.time}</div>
                            <div class="mb-3"><strong>Signos Vitales:</strong> ${data.vitals}</div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Seguimiento</h6>
                            <div class="mb-2"><strong>Próxima Cita:</strong> ${data.nextAppointment}</div>
                            <div class="mb-2"><strong>Estado:</strong> <span class="badge bg-success">Completada</span></div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">Motivo de Consulta</h6>
                        <p>${data.reason}</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">Diagnóstico</h6>
                        <p>${data.diagnosis}</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">Tratamiento</h6>
                        <p>${data.treatment}</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">Observaciones Médicas</h6>
                        <p>${data.observations}</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="printConsultation(${id})">
                        <i class="fas fa-print me-1"></i>Imprimir
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function viewLabResults(id) {
    const labData = {
        1: {
            title: "Perfil Lipídico Completo - 20/07/2025",
            laboratory: "Laboratorio Central",
            doctor: "Dr. García López",
            date: "20/07/2025",
            time: "08:30",
            results: [
                { parameter: "Colesterol Total", value: "180", unit: "mg/dl", reference: "< 200", status: "normal" },
                { parameter: "HDL Colesterol", value: "55", unit: "mg/dl", reference: "> 40", status: "normal" },
                { parameter: "LDL Colesterol", value: "110", unit: "mg/dl", reference: "< 130", status: "normal" },
                { parameter: "Triglicéridos", value: "120", unit: "mg/dl", reference: "< 150", status: "normal" },
                { parameter: "Glucosa en Ayunas", value: "95", unit: "mg/dl", reference: "70-100", status: "normal" },
                { parameter: "Hemoglobina A1c", value: "5.2", unit: "%", reference: "< 5.7", status: "normal" }
            ],
            interpretation: "Todos los valores se encuentran dentro de los rangos normales. Perfil lipídico y glucémico óptimo.",
            recommendations: "Mantener dieta balanceada y actividad física regular. Control en 6 meses."
        }
    };
    
    const data = labData[id] || labData[1];
    
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">${data.title}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="border-start border-primary border-4 ps-3">
                                <div class="small text-muted">Laboratorio</div>
                                <div class="fw-bold">${data.laboratory}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border-start border-success border-4 ps-3">
                                <div class="small text-muted">Fecha y Hora</div>
                                <div class="fw-bold">${data.date} - ${data.time}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border-start border-info border-4 ps-3">
                                <div class="small text-muted">Médico Solicitante</div>
                                <div class="fw-bold">${data.doctor}</div>
                            </div>
                        </div>
                    </div>
                    
                    <h6 class="text-primary mb-3">Resultados Detallados</h6>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Parámetro</th>
                                    <th class="text-center">Resultado</th>
                                    <th class="text-center">Unidad</th>
                                    <th class="text-center">Referencia</th>
                                    <th class="text-center">Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.results.map(result => `
                                    <tr>
                                        <td class="fw-medium">${result.parameter}</td>
                                        <td class="text-center fw-bold">${result.value}</td>
                                        <td class="text-center text-muted">${result.unit}</td>
                                        <td class="text-center text-muted">${result.reference}</td>
                                        <td class="text-center">
                                            <span class="badge ${result.status === 'normal' ? 'bg-success' : result.status === 'high' ? 'bg-warning' : 'bg-danger'}">
                                                ${result.status === 'normal' ? 'Normal' : result.status === 'high' ? 'Alto' : 'Bajo'}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="text-primary">Interpretación Médica</h6>
                                    <p class="mb-2">${data.interpretation}</p>
                                    <h6 class="text-primary">Recomendaciones</h6>
                                    <p class="mb-0">${data.recommendations}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="printLabResults(${id})">
                        <i class="fas fa-print me-1"></i>Imprimir
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="downloadLabResults(${id})">
                        <i class="fas fa-download me-1"></i>Descargar PDF
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function printConsultation(id) {
    // Generar contenido de impresión para la consulta
    const consultationData = {
        1: {
            title: "Consulta General - 25/07/2025",
            doctor: "Dr. García López",
            time: "10:30",
            reason: "Control de rutina anual",
            diagnosis: "Estado de salud óptimo", 
            treatment: "Continuar con hábitos saludables",
            observations: "Paciente presenta buen estado general. Se recomienda mantener actividad física regular y dieta balanceada.",
            vitals: "PA: 120/80, FC: 72 bpm, Temp: 36.5°C, Peso: 70kg"
        }
    };
    
    const data = consultationData[id] || consultationData[1];
    
    // Crear ventana de impresión
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    printWindow.document.write(`
        <html>
            <head>
                <title>Consulta Médica - ${data.title}</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    @media print {
                        .no-print { display: none; }
                        body { font-size: 12px; }
                    }
                    .header { border-bottom: 2px solid #007bff; padding-bottom: 15px; margin-bottom: 20px; }
                    .section { margin-bottom: 15px; }
                </style>
            </head>
            <body class="p-4">
                <div class="header">
                    <h2 class="text-primary">TopicTales Biomédica</h2>
                    <h4>${data.title}</h4>
                    <div class="row">
                        <div class="col-6">
                            <strong>Médico:</strong> ${data.doctor}<br>
                            <strong>Hora:</strong> ${data.time}
                        </div>
                        <div class="col-6">
                            <strong>Paciente:</strong> {{ patient.get_full_name }}<br>
                            <strong>ID:</strong> {{ patient.patient_id }}
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h6 class="text-primary">Signos Vitales</h6>
                    <p>${data.vitals}</p>
                </div>
                
                <div class="section">
                    <h6 class="text-primary">Motivo de Consulta</h6>
                    <p>${data.reason}</p>
                </div>
                
                <div class="section">
                    <h6 class="text-primary">Diagnóstico</h6>
                    <p>${data.diagnosis}</p>
                </div>
                
                <div class="section">
                    <h6 class="text-primary">Tratamiento</h6>
                    <p>${data.treatment}</p>
                </div>
                
                <div class="section">
                    <h6 class="text-primary">Observaciones</h6>
                    <p>${data.observations}</p>
                </div>
                
                <div class="mt-4 text-center text-muted">
                    <small>Documento generado el ${new Date().toLocaleString()}</small>
                </div>
                
                <div class="no-print mt-3 text-center">
                    <button class="btn btn-primary" onclick="window.print()">Imprimir</button>
                    <button class="btn btn-secondary ms-2" onclick="window.close()">Cerrar</button>
                </div>
            </body>
        </html>
    `);
    printWindow.document.close();
}

function printLabResults(id) {
    // Crear ventana de impresión para resultados de laboratorio
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    printWindow.document.write(`
        <html>
            <head>
                <title>Resultados de Laboratorio - Perfil Lipídico</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    @media print {
                        .no-print { display: none; }
                        body { font-size: 12px; }
                    }
                    .header { border-bottom: 2px solid #007bff; padding-bottom: 15px; margin-bottom: 20px; }
                    .lab-header { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                </style>
            </head>
            <body class="p-4">
                <div class="header">
                    <h3 class="text-primary">Laboratorio Central</h3>
                    <h4>Perfil Lipídico Completo</h4>
                </div>
                
                <div class="lab-header">
                    <div class="row">
                        <div class="col-4">
                            <strong>Paciente:</strong> {{ patient.get_full_name }}<br>
                            <strong>ID:</strong> {{ patient.patient_id }}
                        </div>
                        <div class="col-4">
                            <strong>Fecha:</strong> 20/07/2025<br>
                            <strong>Hora:</strong> 08:30
                        </div>
                        <div class="col-4">
                            <strong>Médico:</strong> Dr. García López<br>
                            <strong>Laboratorio:</strong> Laboratorio Central
                        </div>
                    </div>
                </div>
                
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Parámetro</th>
                            <th class="text-center">Resultado</th>
                            <th class="text-center">Unidad</th>
                            <th class="text-center">Referencia</th>
                            <th class="text-center">Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Colesterol Total</td>
                            <td class="text-center fw-bold">180</td>
                            <td class="text-center">mg/dl</td>
                            <td class="text-center">< 200</td>
                            <td class="text-center"><span class="badge bg-success">Normal</span></td>
                        </tr>
                        <tr>
                            <td>HDL Colesterol</td>
                            <td class="text-center fw-bold">55</td>
                            <td class="text-center">mg/dl</td>
                            <td class="text-center">> 40</td>
                            <td class="text-center"><span class="badge bg-success">Normal</span></td>
                        </tr>
                        <tr>
                            <td>LDL Colesterol</td>
                            <td class="text-center fw-bold">110</td>
                            <td class="text-center">mg/dl</td>
                            <td class="text-center">< 130</td>
                            <td class="text-center"><span class="badge bg-success">Normal</span></td>
                        </tr>
                        <tr>
                            <td>Triglicéridos</td>
                            <td class="text-center fw-bold">120</td>
                            <td class="text-center">mg/dl</td>
                            <td class="text-center">< 150</td>
                            <td class="text-center"><span class="badge bg-success">Normal</span></td>
                        </tr>
                        <tr>
                            <td>Glucosa en Ayunas</td>
                            <td class="text-center fw-bold">95</td>
                            <td class="text-center">mg/dl</td>
                            <td class="text-center">70-100</td>
                            <td class="text-center"><span class="badge bg-success">Normal</span></td>
                        </tr>
                        <tr>
                            <td>Hemoglobina A1c</td>
                            <td class="text-center fw-bold">5.2</td>
                            <td class="text-center">%</td>
                            <td class="text-center">< 5.7</td>
                            <td class="text-center"><span class="badge bg-success">Normal</span></td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="mt-4">
                    <h6 class="text-primary">Interpretación Médica</h6>
                    <p>Todos los valores se encuentran dentro de los rangos normales. Perfil lipídico y glucémico óptimo.</p>
                    
                    <h6 class="text-primary">Recomendaciones</h6>
                    <p>Mantener dieta balanceada y actividad física regular. Control en 6 meses.</p>
                </div>
                
                <div class="mt-4 text-center text-muted">
                    <small>Documento generado el ${new Date().toLocaleString()}</small>
                </div>
                
                <div class="no-print mt-3 text-center">
                    <button class="btn btn-primary" onclick="window.print()">Imprimir</button>
                    <button class="btn btn-secondary ms-2" onclick="window.close()">Cerrar</button>
                </div>
            </body>
        </html>
    `);
    printWindow.document.close();
}

function downloadLabResults(id) {
    // Generar y descargar PDF usando jsPDF
    const { jsPDF } = window.jspdf || {};
    
    if (!jsPDF) {
        // Fallback: generar archivo de texto plano
        const content = `
LABORATORIO CENTRAL
===================

PERFIL LIPÍDICO COMPLETO
Fecha: 20/07/2025 - 08:30

Paciente: {{ patient.get_full_name }}
ID: {{ patient.patient_id }}
Médico Solicitante: Dr. García López

RESULTADOS:
-----------
Colesterol Total:    180 mg/dl    (Referencia: < 200)    NORMAL
HDL Colesterol:      55 mg/dl     (Referencia: > 40)     NORMAL  
LDL Colesterol:      110 mg/dl    (Referencia: < 130)    NORMAL
Triglicéridos:       120 mg/dl    (Referencia: < 150)    NORMAL
Glucosa en Ayunas:   95 mg/dl     (Referencia: 70-100)   NORMAL
Hemoglobina A1c:     5.2 %        (Referencia: < 5.7)    NORMAL

INTERPRETACIÓN:
---------------
Todos los valores se encuentran dentro de los rangos normales. 
Perfil lipídico y glucémico óptimo.

RECOMENDACIONES:
----------------
Mantener dieta balanceada y actividad física regular. 
Control en 6 meses.

Documento generado: ${new Date().toLocaleString()}
        `;
        
        // Crear y descargar archivo de texto
        const blob = new Blob([content], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `resultados_laboratorio_${id}_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        // Mostrar confirmación
        setTimeout(() => {
            alert('Archivo de resultados descargado exitosamente como archivo de texto.');
        }, 100);
    } else {
        // Si jsPDF está disponible, generar PDF real
        const doc = new jsPDF();
        doc.text('Resultados de Laboratorio', 20, 20);
        // Aquí se agregaría el contenido completo del PDF
        doc.save(`resultados_laboratorio_${id}.pdf`);
    }
}

function addConsultation() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Consulta Médica</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="consultation-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha</label>
                                <input type="date" class="form-control" name="date" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Hora</label>
                                <input type="time" class="form-control" name="time" value="${new Date().toTimeString().slice(0,5)}" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Médico</label>
                            <select class="form-select" name="doctor" required>
                                <option value="">Seleccionar médico</option>
                                <option value="1">Dr. García López</option>
                                <option value="2">Dr. Martínez Ruiz</option>
                                <option value="3">Dra. Fernández Castro</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Motivo de Consulta</label>
                            <input type="text" class="form-control" name="reason" placeholder="Ej: Control de rutina, dolor de cabeza..." required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Diagnóstico</label>
                            <textarea class="form-control" name="diagnosis" rows="2" placeholder="Diagnóstico o impresión clínica"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tratamiento</label>
                            <textarea class="form-control" name="treatment" rows="2" placeholder="Medicamentos, indicaciones, etc."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observaciones</label>
                            <textarea class="form-control" name="observations" rows="3" placeholder="Notas adicionales, evolución, etc."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveConsultation()">Guardar Consulta</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function addLabResult() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Resultado de Laboratorio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="lab-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha del Estudio</label>
                                <input type="date" class="form-control" name="date" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Laboratorio</label>
                                <input type="text" class="form-control" name="laboratory" placeholder="Nombre del laboratorio" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Estudio</label>
                            <select class="form-select" name="study_type" required>
                                <option value="">Seleccionar tipo</option>
                                <option value="Biometría Hemática">Biometría Hemática</option>
                                <option value="Química Sanguínea">Química Sanguínea</option>
                                <option value="Perfil Lipídico">Perfil Lipídico</option>
                                <option value="Examen General de Orina">Examen General de Orina</option>
                                <option value="Función Tiroidea">Función Tiroidea</option>
                                <option value="Marcadores Tumorales">Marcadores Tumorales</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Resultados Principales</label>
                            <textarea class="form-control" name="main_results" rows="4" placeholder="Ej: Glucosa: 95 mg/dl, Colesterol: 180 mg/dl, etc." required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Interpretación</label>
                            <textarea class="form-control" name="interpretation" rows="2" placeholder="Valores normales/anormales, conclusiones"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notas Adicionales</label>
                            <textarea class="form-control" name="notes" rows="2" placeholder="Observaciones del médico"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveLabResult()">Guardar Resultado</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function addNote() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Nota Médica</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="note-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha</label>
                                <input type="date" class="form-control" name="date" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Hora</label>
                                <input type="time" class="form-control" name="time" value="${new Date().toTimeString().slice(0,5)}" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Nota</label>
                            <select class="form-select" name="note_type" required>
                                <option value="">Seleccionar tipo</option>
                                <option value="Evolución">Evolución</option>
                                <option value="Observación">Observación</option>
                                <option value="Recordatorio">Recordatorio</option>
                                <option value="Seguimiento">Seguimiento</option>
                                <option value="Administrativo">Administrativo</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Título</label>
                            <input type="text" class="form-control" name="title" placeholder="Título de la nota" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contenido</label>
                            <textarea class="form-control" name="content" rows="5" placeholder="Contenido de la nota médica..." required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveNote()">Guardar Nota</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function saveConsultation() {
    const form = document.getElementById('consultation-form');
    const formData = new FormData(form);
    
    // Simular guardado
    alert('Consulta médica guardada exitosamente');
    bootstrap.Modal.getInstance(document.querySelector('.modal')).hide();
    
    // Simular actualización de la página
    setTimeout(() => location.reload(), 1000);
}

function saveLabResult() {
    const form = document.getElementById('lab-form');
    const formData = new FormData(form);
    
    // Simular guardado
    alert('Resultado de laboratorio guardado exitosamente');
    bootstrap.Modal.getInstance(document.querySelector('.modal')).hide();
    
    // Simular actualización de la página
    setTimeout(() => location.reload(), 1000);
}

function saveNote() {
    const form = document.getElementById('note-form');
    const formData = new FormData(form);
    
    // Simular guardado
    alert('Nota médica guardada exitosamente');
    bootstrap.Modal.getInstance(document.querySelector('.modal')).hide();
    
    // Simular actualización de la página
    setTimeout(() => location.reload(), 1000);
}
</script>
{% endblock %}