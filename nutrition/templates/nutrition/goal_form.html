{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ title }} - TopicTalesBiom{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }
    
    .section-header {
        background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        margin: 20px 0 15px 0;
    }
    
    .section-header h5 {
        margin: 0;
        font-weight: 600;
    }
    
    .form-group label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
    }
    
    .form-control {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        padding: 10px 15px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #6f42c1;
        box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
    }
    
    .goal-preview {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        border: 2px dashed #dee2e6;
    }
    
    .goal-type-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .goal-type-option {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .goal-type-option:hover,
    .goal-type-option.selected {
        border-color: #6f42c1;
        background: #f8f5ff;
    }
    
    .goal-type-option i {
        font-size: 2rem;
        margin-bottom: 10px;
        color: #6f42c1;
    }
    
    .priority-selector {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .priority-option {
        padding: 8px 16px;
        border: 2px solid #e9ecef;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .priority-option:hover,
    .priority-option.selected {
        border-color: #6f42c1;
        background: #f8f5ff;
    }
    
    .priority-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    
    .priority-1 .priority-dot { background-color: #28a745; }
    .priority-2 .priority-dot { background-color: #ffc107; }
    .priority-3 .priority-dot { background-color: #fd7e14; }
    .priority-4 .priority-dot { background-color: #dc3545; }
    
    .progress-simulator {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
        border: 1px solid #e9ecef;
    }
    
    .progress-bar-preview {
        height: 10px;
        background: #e9ecef;
        border-radius: 5px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #6f42c1, #e83e8c);
        transition: width 0.3s ease;
        border-radius: 5px;
    }
    
    .date-helper {
        background: #e7f3ff;
        border-radius: 8px;
        padding: 10px;
        margin-top: 10px;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-primary">
                        <i class="fas fa-bullseye me-2"></i>{{ title }}
                    </h1>
                    <p class="text-muted mb-0">Define objetivos específicos y medibles para el paciente</p>
                </div>
                <a href="{% url 'nutrition:goals_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Volver a Lista
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Formulario Principal -->
        <div class="col-lg-8">
            <div class="form-container">
                <form method="post" id="goalForm">
                    {% csrf_token %}
                    {% crispy form %}
                </form>
            </div>
        </div>
        
        <!-- Panel de Asistentes -->
        <div class="col-lg-4">
            <!-- Selector de Tipo de Meta -->
            <div class="goal-preview">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-target me-2"></i>Tipos de Meta Disponibles
                </h5>
                <div class="goal-type-selector">
                    <div class="goal-type-option" data-type="weight">
                        <i class="fas fa-weight"></i>
                        <div class="fw-bold">Peso</div>
                        <small class="text-muted">Meta de peso corporal</small>
                    </div>
                    <div class="goal-type-option" data-type="bmi">
                        <i class="fas fa-calculator"></i>
                        <div class="fw-bold">IMC</div>
                        <small class="text-muted">Índice de masa corporal</small>
                    </div>
                    <div class="goal-type-option" data-type="body_fat">
                        <i class="fas fa-chart-pie"></i>
                        <div class="fw-bold">Grasa Corporal</div>
                        <small class="text-muted">% de grasa corporal</small>
                    </div>
                    <div class="goal-type-option" data-type="muscle_mass">
                        <i class="fas fa-dumbbell"></i>
                        <div class="fw-bold">Masa Muscular</div>
                        <small class="text-muted">Kilogramos de músculo</small>
                    </div>
                    <div class="goal-type-option" data-type="waist">
                        <i class="fas fa-ruler"></i>
                        <div class="fw-bold">Circunferencia</div>
                        <small class="text-muted">Cintura en cm</small>
                    </div>
                    <div class="goal-type-option" data-type="habit">
                        <i class="fas fa-heart"></i>
                        <div class="fw-bold">Hábito</div>
                        <small class="text-muted">Cambio de comportamiento</small>
                    </div>
                </div>
            </div>
            
            <!-- Selector de Prioridad -->
            <div class="goal-preview">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-flag me-2"></i>Nivel de Prioridad
                </h5>
                <div class="priority-selector">
                    <div class="priority-option priority-1" data-priority="1">
                        <div class="priority-dot"></div>
                        <span>Baja</span>
                    </div>
                    <div class="priority-option priority-2" data-priority="2">
                        <div class="priority-dot"></div>
                        <span>Media</span>
                    </div>
                    <div class="priority-option priority-3" data-priority="3">
                        <div class="priority-dot"></div>
                        <span>Alta</span>
                    </div>
                    <div class="priority-option priority-4" data-priority="4">
                        <div class="priority-dot"></div>
                        <span>Crítica</span>
                    </div>
                </div>
                <div class="mt-3 small text-muted">
                    <div><strong>Baja:</strong> Objetivos generales de bienestar</div>
                    <div><strong>Media:</strong> Mejoras importantes en salud</div>
                    <div><strong>Alta:</strong> Cambios necesarios urgentes</div>
                    <div><strong>Crítica:</strong> Intervención médica requerida</div>
                </div>
            </div>
            
            <!-- Simulador de Progreso -->
            <div class="goal-preview">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-chart-line me-2"></i>Simulador de Progreso
                </h5>
                <div class="progress-simulator">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Valor Actual:</span>
                        <span id="currentValueDisplay">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Valor Meta:</span>
                        <span id="targetValueDisplay">0</span>
                    </div>
                    <div class="progress-bar-preview">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="text-center mt-2">
                        <span class="fw-bold" id="progressPercentage">0%</span> completado
                    </div>
                </div>
            </div>
            
            <!-- Calculadora de Fechas -->
            <div class="goal-preview">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-calendar-alt me-2"></i>Planificación Temporal
                </h5>
                <div class="small">
                    <div class="mb-2">
                        <strong>Duración Recomendada por Tipo:</strong>
                    </div>
                    <div class="mb-1"><strong>Peso:</strong> 4-12 semanas</div>
                    <div class="mb-1"><strong>IMC:</strong> 8-16 semanas</div>
                    <div class="mb-1"><strong>Grasa Corporal:</strong> 12-24 semanas</div>
                    <div class="mb-1"><strong>Masa Muscular:</strong> 8-20 semanas</div>
                    <div class="mb-1"><strong>Circunferencia:</strong> 6-12 semanas</div>
                    <div class="mb-3"><strong>Hábitos:</strong> 4-8 semanas</div>
                    
                    <div id="dateHelper" class="date-helper" style="display: none;">
                        <i class="fas fa-lightbulb me-1"></i>
                        <span id="dateRecommendation"></span>
                    </div>
                </div>
            </div>
            
            <!-- Ejemplos de Metas -->
            <div class="goal-preview">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-lightbulb me-2"></i>Ejemplos de Metas SMART
                </h5>
                <div class="small">
                    <div class="alert alert-info py-2 mb-2">
                        <strong>Peso:</strong> "Reducir 5kg en 8 semanas mediante dieta balanceada y ejercicio"
                    </div>
                    <div class="alert alert-success py-2 mb-2">
                        <strong>Hábito:</strong> "Beber 2 litros de agua diarios durante 4 semanas"
                    </div>
                    <div class="alert alert-warning py-2">
                        <strong>IMC:</strong> "Reducir IMC de 28 a 25 en 12 semanas"
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Referencias a campos del formulario
    const goalTypeField = document.querySelector('select[name="goal_type"]');
    const priorityField = document.querySelector('select[name="priority"]');
    const targetValueField = document.querySelector('input[name="target_value"]');
    const currentValueField = document.querySelector('input[name="current_value"]');
    const startDateField = document.querySelector('input[name="start_date"]');
    const targetDateField = document.querySelector('input[name="target_date"]');
    
    // Selectores visuales
    const goalTypeOptions = document.querySelectorAll('.goal-type-option');
    const priorityOptions = document.querySelectorAll('.priority-option');
    
    // Inicializar selectores visuales
    goalTypeOptions.forEach(option => {
        option.addEventListener('click', function() {
            const selectedType = this.dataset.type;
            
            // Actualizar visual
            goalTypeOptions.forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            
            // Actualizar campo del formulario
            if (goalTypeField) {
                goalTypeField.value = selectedType;
                updateDateRecommendation(selectedType);
            }
        });
    });
    
    priorityOptions.forEach(option => {
        option.addEventListener('click', function() {
            const selectedPriority = this.dataset.priority;
            
            // Actualizar visual
            priorityOptions.forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            
            // Actualizar campo del formulario
            if (priorityField) {
                priorityField.value = selectedPriority;
            }
        });
    });
    
    // Actualizar simulador de progreso
    function updateProgressSimulator() {
        const currentValue = parseFloat(currentValueField?.value || 0);
        const targetValue = parseFloat(targetValueField?.value || 0);
        
        document.getElementById('currentValueDisplay').textContent = currentValue || '0';
        document.getElementById('targetValueDisplay').textContent = targetValue || '0';
        
        if (currentValue && targetValue && targetValue !== currentValue) {
            let progress = 0;
            
            // Calcular progreso basado en el tipo de meta
            const goalType = goalTypeField?.value;
            if (goalType === 'weight' && targetValue < currentValue) {
                // Meta de pérdida de peso
                progress = Math.max(0, Math.min(100, ((currentValue - targetValue) / currentValue) * 100));
            } else if (goalType === 'weight' && targetValue > currentValue) {
                // Meta de ganancia de peso
                progress = Math.max(0, Math.min(100, (currentValue / targetValue) * 100));
            } else {
                // Progreso general hacia la meta
                progress = Math.max(0, Math.min(100, (currentValue / targetValue) * 100));
            }
            
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressPercentage').textContent = Math.round(progress) + '%';
        } else {
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressPercentage').textContent = '0%';
        }
    }
    
    // Recomendaciones de fechas
    function updateDateRecommendation(goalType) {
        const recommendations = {
            'weight': { weeks: [4, 12], text: 'Para cambios de peso se recomienda entre 4-12 semanas' },
            'bmi': { weeks: [8, 16], text: 'Para cambios de IMC se recomienda entre 8-16 semanas' },
            'body_fat': { weeks: [12, 24], text: 'Para reducir grasa corporal se recomienda entre 12-24 semanas' },
            'muscle_mass': { weeks: [8, 20], text: 'Para ganar masa muscular se recomienda entre 8-20 semanas' },
            'waist': { weeks: [6, 12], text: 'Para reducir circunferencia se recomienda entre 6-12 semanas' },
            'habit': { weeks: [4, 8], text: 'Para formar nuevos hábitos se recomienda entre 4-8 semanas' }
        };
        
        const rec = recommendations[goalType];
        if (rec) {
            document.getElementById('dateRecommendation').textContent = rec.text;
            document.getElementById('dateHelper').style.display = 'block';
            
            // Sugerir fecha objetivo si hay fecha de inicio
            if (startDateField?.value) {
                const startDate = new Date(startDateField.value);
                const suggestedEndDate = new Date(startDate);
                suggestedEndDate.setDate(startDate.getDate() + (rec.weeks[0] * 7));
                
                if (targetDateField && !targetDateField.value) {
                    targetDateField.value = suggestedEndDate.toISOString().split('T')[0];
                }
            }
        } else {
            document.getElementById('dateHelper').style.display = 'none';
        }
    }
    
    // Event listeners
    if (targetValueField) {
        targetValueField.addEventListener('input', updateProgressSimulator);
    }
    
    if (currentValueField) {
        currentValueField.addEventListener('input', updateProgressSimulator);
    }
    
    if (goalTypeField) {
        goalTypeField.addEventListener('change', function() {
            updateDateRecommendation(this.value);
            updateProgressSimulator();
        });
    }
    
    if (startDateField) {
        startDateField.addEventListener('change', function() {
            const goalType = goalTypeField?.value;
            if (goalType) {
                updateDateRecommendation(goalType);
            }
        });
    }
    
    // Inicializar valores
    updateProgressSimulator();
    
    // Sincronizar selectores visuales con campos del formulario
    if (goalTypeField?.value) {
        const selectedOption = document.querySelector(`[data-type="${goalTypeField.value}"]`);
        if (selectedOption) {
            selectedOption.classList.add('selected');
            updateDateRecommendation(goalTypeField.value);
        }
    }
    
    if (priorityField?.value) {
        const selectedOption = document.querySelector(`[data-priority="${priorityField.value}"]`);
        if (selectedOption) {
            selectedOption.classList.add('selected');
        }
    }
});
</script>
{% endblock %}