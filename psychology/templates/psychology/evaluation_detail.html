{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - TopicTalesBiom{% endblock %}

{% block extra_css %}
<style>
    .evaluation-detail-card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }
    
    .evaluation-header {
        background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
        color: white;
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 30px;
    }
    
    .completion-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .completed { background-color: #d4edda; color: #155724; }
    .in-progress { background-color: #fff3cd; color: #856404; }
    
    .section-divider {
        border-bottom: 2px solid #f1f3f4;
        margin: 30px 0;
        padding-bottom: 20px;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .info-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid #6f42c1;
    }
    
    .info-label {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    
    .info-value {
        color: #212529;
        line-height: 1.4;
    }
    
    .test-result-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        transition: box-shadow 0.3s ease;
    }
    
    .test-result-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .scale-scores {
        background: #e8f4fd;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
    }
    
    .diagnosis-section {
        background: #fff8e1;
        border: 1px solid #ffecb3;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
    }
    
    .recommendations-section {
        background: #e8f5e8;
        border: 1px solid #c8e6c9;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
    }
    
    .therapy-session-mini {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid #17a2b8;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0" style="color: #6f42c1;">
                        <i class="fas fa-clipboard-list me-2"></i>{{ title }}
                    </h1>
                    <p class="text-muted mb-0">Evaluación psicológica completa</p>
                </div>
                <div class="btn-group">
                    <a href="{% url 'psychology:evaluation_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver a Lista
                    </a>
                    <a href="{% url 'psychology:evaluation_edit' evaluation.pk %}" class="btn btn-outline-primary">
                        <i class="fas fa-edit me-2"></i>Editar
                    </a>
                    <a href="#" class="btn btn-outline-info">
                        <i class="fas fa-file-pdf me-2"></i>Exportar PDF
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Contenido Principal -->
        <div class="col-lg-8">
            <!-- Header de la Evaluación -->
            <div class="evaluation-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-1">{{ evaluation.patient.get_full_name }}</h4>
                        <p class="mb-0 opacity-75">
                            {{ evaluation.get_evaluation_type_display }} - {{ evaluation.evaluation_date|date:"d/m/Y" }}
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="completion-badge {% if evaluation.is_completed %}completed{% else %}in-progress{% endif %}">
                            {% if evaluation.is_completed %}
                                <i class="fas fa-check-circle me-1"></i>Completada
                            {% else %}
                                <i class="fas fa-clock me-1"></i>En Proceso
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Información Básica -->
            <div class="evaluation-detail-card">
                <h5 class="mb-4">
                    <i class="fas fa-info-circle me-2 text-primary"></i>Información de la Evaluación
                </h5>
                
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Fecha de Evaluación</div>
                        <div class="info-value">{{ evaluation.evaluation_date|date:"d/m/Y H:i" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Fuente de Referencia</div>
                        <div class="info-value">{{ evaluation.get_referral_source_display }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Duración de Síntomas</div>
                        <div class="info-value">{{ evaluation.symptoms_duration|default:"No especificada" }}</div>
                    </div>
                    {% if evaluation.follow_up_date %}
                    <div class="info-item">
                        <div class="info-label">Fecha de Seguimiento</div>
                        <div class="info-value">{{ evaluation.follow_up_date|date:"d/m/Y" }}</div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="section-divider">
                    <h6>Motivo de Referencia</h6>
                </div>
                <p>{{ evaluation.referral_reason }}</p>
                
                <div class="section-divider">
                    <h6>Motivo de Consulta Principal</h6>
                </div>
                <p>{{ evaluation.chief_complaint }}</p>
            </div>
            
            <!-- Historia Clínica -->
            <div class="evaluation-detail-card">
                <h5 class="mb-4">
                    <i class="fas fa-history me-2 text-primary"></i>Historia Clínica
                </h5>
                
                {% if evaluation.previous_treatments %}
                <div class="section-divider">
                    <h6>Tratamientos Previos</h6>
                </div>
                <p>{{ evaluation.previous_treatments }}</p>
                {% endif %}
                
                {% if evaluation.medications %}
                <div class="section-divider">
                    <h6>Medicamentos Actuales</h6>
                </div>
                <p>{{ evaluation.medications }}</p>
                {% endif %}
                
                {% if evaluation.family_mental_health %}
                <div class="section-divider">
                    <h6>Antecedentes Familiares de Salud Mental</h6>
                </div>
                <p>{{ evaluation.family_mental_health }}</p>
                {% endif %}
                
                {% if evaluation.educational_background %}
                <div class="section-divider">
                    <h6>Antecedentes Educativos</h6>
                </div>
                <p>{{ evaluation.educational_background }}</p>
                {% endif %}
                
                {% if evaluation.occupational_history %}
                <div class="section-divider">
                    <h6>Historia Laboral</h6>
                </div>
                <p>{{ evaluation.occupational_history }}</p>
                {% endif %}
            </div>
            
            <!-- Examen del Estado Mental -->
            <div class="evaluation-detail-card">
                <h5 class="mb-4">
                    <i class="fas fa-brain me-2 text-primary"></i>Examen del Estado Mental
                </h5>
                
                <div class="info-grid">
                    {% if evaluation.appearance %}
                    <div class="info-item">
                        <div class="info-label">Apariencia y Comportamiento</div>
                        <div class="info-value">{{ evaluation.appearance }}</div>
                    </div>
                    {% endif %}
                    {% if evaluation.mood_affect %}
                    <div class="info-item">
                        <div class="info-label">Estado de Ánimo y Afecto</div>
                        <div class="info-value">{{ evaluation.mood_affect }}</div>
                    </div>
                    {% endif %}
                    {% if evaluation.thought_process %}
                    <div class="info-item">
                        <div class="info-label">Proceso de Pensamiento</div>
                        <div class="info-value">{{ evaluation.thought_process }}</div>
                    </div>
                    {% endif %}
                    {% if evaluation.perception %}
                    <div class="info-item">
                        <div class="info-label">Percepción</div>
                        <div class="info-value">{{ evaluation.perception }}</div>
                    </div>
                    {% endif %}
                    {% if evaluation.cognition %}
                    <div class="info-item">
                        <div class="info-label">Función Cognitiva</div>
                        <div class="info-value">{{ evaluation.cognition }}</div>
                    </div>
                    {% endif %}
                    {% if evaluation.insight_judgment %}
                    <div class="info-item">
                        <div class="info-label">Insight y Juicio</div>
                        <div class="info-value">{{ evaluation.insight_judgment }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Puntuaciones de Escalas -->
            {% if evaluation.scale_scores %}
            <div class="evaluation-detail-card">
                <h5 class="mb-4">
                    <i class="fas fa-calculator me-2 text-primary"></i>Puntuaciones de Escalas
                </h5>
                
                <div class="scale-scores">
                    <pre>{{ evaluation.scale_scores|pprint }}</pre>
                </div>
            </div>
            {% endif %}
            
            <!-- Diagnóstico -->
            <div class="evaluation-detail-card">
                <h5 class="mb-4">
                    <i class="fas fa-stethoscope me-2 text-primary"></i>Diagnóstico
                </h5>
                
                {% if evaluation.provisional_diagnosis %}
                <div class="diagnosis-section">
                    <h6>Diagnóstico Provisional</h6>
                    <p>{{ evaluation.provisional_diagnosis }}</p>
                </div>
                {% endif %}
                
                {% if evaluation.differential_diagnosis %}
                <div class="diagnosis-section">
                    <h6>Diagnóstico Diferencial</h6>
                    <p>{{ evaluation.differential_diagnosis }}</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Recomendaciones y Plan -->
            <div class="evaluation-detail-card">
                <h5 class="mb-4">
                    <i class="fas fa-lightbulb me-2 text-primary"></i>Recomendaciones y Tratamiento
                </h5>
                
                <div class="recommendations-section">
                    <h6>Recomendaciones</h6>
                    <p>{{ evaluation.recommendations }}</p>
                </div>
                
                {% if evaluation.treatment_plan %}
                <div class="recommendations-section">
                    <h6>Plan de Tratamiento</h6>
                    <p>{{ evaluation.treatment_plan }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Panel Lateral -->
        <div class="col-lg-4">
            <!-- Información del Paciente -->
            <div class="evaluation-detail-card">
                <h6 class="mb-3">
                    <i class="fas fa-user me-2 text-primary"></i>Información del Paciente
                </h6>
                
                <div class="text-center mb-3">
                    <div class="patient-avatar bg-primary text-white rounded-circle mx-auto mb-2" 
                         style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                        {{ evaluation.patient.first_name.0 }}{{ evaluation.patient.last_name.0 }}
                    </div>
                    <h6 class="mb-1">{{ evaluation.patient.get_full_name }}</h6>
                    <small class="text-muted">{{ evaluation.patient.identification_number }}</small>
                </div>
                
                <div class="small">
                    <div class="mb-2">
                        <strong>Edad:</strong> {{ evaluation.patient.get_age }} años
                    </div>
                    <div class="mb-2">
                        <strong>Teléfono:</strong> {{ evaluation.patient.phone_number|default:"No registrado" }}
                    </div>
                    <div class="mb-2">
                        <strong>Email:</strong> {{ evaluation.patient.email|default:"No registrado" }}
                    </div>
                </div>
            </div>
            
            <!-- Información del Psicólogo -->
            <div class="evaluation-detail-card">
                <h6 class="mb-3">
                    <i class="fas fa-user-md me-2 text-primary"></i>Psicólogo
                </h6>
                
                <div class="d-flex align-items-center">
                    <div class="bg-secondary text-white rounded-circle me-3" 
                         style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        {{ evaluation.psychologist.first_name.0 }}{{ evaluation.psychologist.last_name.0 }}
                    </div>
                    <div>
                        <div class="fw-bold">{{ evaluation.psychologist.get_full_name }}</div>
                        <small class="text-muted">Psicólogo Clínico</small>
                    </div>
                </div>
            </div>
            
            <!-- Resultados de Tests -->
            {% if test_results %}
            <div class="evaluation-detail-card">
                <h6 class="mb-3">
                    <i class="fas fa-chart-bar me-2 text-primary"></i>Resultados de Tests
                </h6>
                
                {% for result in test_results %}
                <div class="test-result-card">
                    <div class="fw-bold mb-2">{{ result.test.name }}</div>
                    <div class="small text-muted mb-2">
                        {{ result.administration_date|date:"d/m/Y" }}
                    </div>
                    <div class="small">
                        {{ result.interpretation|truncatechars:100 }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Plan de Tratamiento -->
            {% if treatment_plan %}
            <div class="evaluation-detail-card">
                <h6 class="mb-3">
                    <i class="fas fa-map me-2 text-primary"></i>Plan de Tratamiento
                </h6>
                
                <div class="small">
                    <div class="mb-2">
                        <strong>Enfoque:</strong> {{ treatment_plan.get_treatment_approach_display }}
                    </div>
                    <div class="mb-2">
                        <strong>Sesiones Estimadas:</strong> {{ treatment_plan.estimated_sessions }}
                    </div>
                    <div class="mb-2">
                        <strong>Frecuencia:</strong> {{ treatment_plan.session_frequency }}
                    </div>
                    <div class="mb-3">
                        <strong>Estado:</strong> 
                        {% if treatment_plan.is_active %}
                            <span class="badge bg-success">Activo</span>
                        {% else %}
                            <span class="badge bg-secondary">Inactivo</span>
                        {% endif %}
                    </div>
                </div>
                
                <a href="{% url 'psychology:treatment_plan_detail' treatment_plan.pk %}" 
                   class="btn btn-outline-primary btn-sm w-100">
                    <i class="fas fa-eye me-1"></i>Ver Plan Completo
                </a>
            </div>
            {% endif %}
            
            <!-- Sesiones de Terapia -->
            {% if therapy_sessions %}
            <div class="evaluation-detail-card">
                <h6 class="mb-3">
                    <i class="fas fa-calendar-check me-2 text-primary"></i>Sesiones de Terapia
                </h6>
                
                {% for session in therapy_sessions %}
                <div class="therapy-session-mini">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <strong class="small">Sesión #{{ session.session_number }}</strong>
                        <span class="badge bg-{{ session.status|default:'secondary' }}">
                            {{ session.get_status_display }}
                        </span>
                    </div>
                    <div class="small text-muted mb-2">
                        <i class="fas fa-calendar me-1"></i>{{ session.session_date|date:"d/m/Y" }}
                        <i class="fas fa-clock ms-2 me-1"></i>{{ session.duration_minutes }}min
                    </div>
                    <div class="small">
                        {{ session.progress_notes|truncatechars:60 }}
                    </div>
                </div>
                {% endfor %}
                
                <div class="text-center">
                    <a href="{% url 'psychology:session_list' %}?evaluation={{ evaluation.pk }}" 
                       class="btn btn-outline-info btn-sm">
                        <i class="fas fa-list me-1"></i>Ver Todas las Sesiones
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Expandir/contraer secciones largas
document.addEventListener('DOMContentLoaded', function() {
    const expandableTexts = document.querySelectorAll('p');
    expandableTexts.forEach(text => {
        if (text.textContent.length > 300) {
            const fullText = text.innerHTML;
            const shortText = text.textContent.substring(0, 300) + '...';
            
            text.innerHTML = shortText + ' <a href="#" class="text-primary expand-link">Ver más</a>';
            text.dataset.fullText = fullText;
            text.dataset.shortText = shortText;
            
            text.querySelector('.expand-link').addEventListener('click', function(e) {
                e.preventDefault();
                toggleText(text, this);
            });
        }
    });
});

function toggleText(textElement, link) {
    const isExpanded = link.textContent === 'Ver menos';
    
    if (isExpanded) {
        textElement.innerHTML = textElement.dataset.shortText + ' <a href="#" class="text-primary expand-link">Ver más</a>';
        textElement.querySelector('.expand-link').addEventListener('click', function(e) {
            e.preventDefault();
            toggleText(textElement, this);
        });
    } else {
        textElement.innerHTML = textElement.dataset.fullText + ' <a href="#" class="text-primary expand-link">Ver menos</a>';
        textElement.querySelector('.expand-link').addEventListener('click', function(e) {
            e.preventDefault();
            toggleText(textElement, this);
        });
    }
}
</script>
{% endblock %}